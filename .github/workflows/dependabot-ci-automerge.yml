name: Dependabot PR - Build & Auto-merge (v3.0.0)

on:
  pull_request:
    branches: [ v3.0.0 ]
    types: [ opened, synchronize, reopened, ready_for_review ]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    if: github.actor == 'dependabot[bot]'
    runs-on: windows-latest
    env:
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: "1"
    steps:
      - uses: actions/checkout@v5

      # (선택) 메타데이터 받아서 셀레니움 변경인지 확인
      - name: Fetch Dependabot metadata
        id: meta
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify only Selenium changed
        shell: bash
        run: |
          # 셀레니움 관련 변경이면 통과, 아니면 실패 처리해 자동 머지 방지
          if [[ "${{ steps.meta.outputs.dependency-names }}" != *"selenium"* ]]; then
            echo "This PR is not updating selenium. Failing to block auto-merge."
            exit 1
          fi

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: astral-sh/setup-uv@v6

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps (JS)
        run: npm ci

      - name: Sync Python deps (within constraints)
        run: uv sync --upgrade

      - name: Project setup
        shell: pwsh
        run: |
          chcp 65001 > $null
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          npm run setup

      - name: Build (no release)
        shell: pwsh
        run: |
          chcp 65001 > $null
          [Console]::OutputEncoding = [System.Text.UTF8Encoding]::new()
          npm run build

  enable-automerge:
    needs: build
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Enable auto-merge (squash)
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --auto
