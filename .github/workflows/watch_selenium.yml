name: Watch Selenium → Build & Patch Release (v3.0.0)

on:
  schedule:
    - cron: "0 15 * * *"   # UTC 15:00 실행
  workflow_dispatch: {}

permissions:
  contents: write   # 버전 파일 커밋/태그/릴리스 조회
  actions: write    # 다른 워크플로우(dispatch) 실행

env:
  TARGET_BRANCH: main
  VERSION_FILE: .ci/selenium-version.txt
  BUILD_WORKFLOW_FILE: build-windows.yml

jobs:
  watch-build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: ${{ env.TARGET_BRANCH }}
          fetch-depth: 0

      - name: Ensure tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Get latest Selenium (PyPI stable only)
        id: pypi
        run: |
          LATEST=$(curl -fsSL https://pypi.org/pypi/selenium/json | jq -r '.info.version')
          echo "PyPI latest = $LATEST"
          # 안정판만(문자 포함 버전: a,b,rc,dev,post 등) 허용하지 않음
          if echo "$LATEST" | grep -Eqi '(a|b|rc|dev|post)'; then
            echo "Pre-release detected ($LATEST). Skip."
            echo "latest=" >> $GITHUB_OUTPUT
            exit 0
          fi
          # 간단히 숫자와 점만 허용
          if ! echo "$LATEST" | grep -Eq '^[0-9]+(\.[0-9]+)*$'; then
            echo "Non-standard version ($LATEST). Skip."
            echo "latest=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

      - name: Read last tracked Selenium
        id: last
        run: |
          if [ -f "${{ env.VERSION_FILE }}" ]; then
            LAST=$(tr -d ' \r\n' < "${{ env.VERSION_FILE }}")
          else
            LAST=""
          fi
          echo "last=$LAST" >> $GITHUB_OUTPUT
          echo "Last tracked = $LAST"

      - name: Decide
        id: decide
        run: |
          if [ -z "${{ steps.pypi.outputs.latest }}" ]; then
            echo "needs_build=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          if [ "${{ steps.pypi.outputs.latest }}" != "${{ steps.last.outputs.last }}" ]; then
            echo "needs_build=true" >> $GITHUB_OUTPUT
          else
            echo "needs_build=false" >> $GITHUB_OUTPUT
          fi

      - name: Update tracked file (commit)
        if: steps.decide.outputs.needs_build == 'true'
        run: |
          mkdir -p "$(dirname "${{ env.VERSION_FILE }}")"
          echo "${{ steps.pypi.outputs.latest }}" > "${{ env.VERSION_FILE }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "${{ env.VERSION_FILE }}"
          git commit -m "chore(ci): track Selenium ${{ steps.pypi.outputs.latest }}"
          git push origin "${{ env.TARGET_BRANCH }}"

      - name: Figure out next patch tag (vX.Y.Z → vX.Y.(Z+1))
        if: steps.decide.outputs.needs_build == 'true'
        id: bump
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 최신 릴리스들 중 semantic tag만 골라 가장 최근 하나
          LATEST_TAG=$(curl -fsSL \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases?per_page=100" \
            | jq -r '[.[] | .tag_name] | map(select(test("^v[0-9]+\\.[0-9]+\\.[0-9]+$"))) | .[0]')
          # releases API는 최신순이 기본이므로 [0]이 가장 최근
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            LATEST_TAG="v3.0.0"   # 초기 기준(예시)
          fi
          echo "Latest release tag = $LATEST_TAG"

          MAJOR=$(echo "$LATEST_TAG" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\1/')
          MINOR=$(echo "$LATEST_TAG" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\2/')
          PATCH=$(echo "$LATEST_TAG" | sed -E 's/^v([0-9]+)\.([0-9]+)\.([0-9]+)$/\3/')
          NEXT="v${MAJOR}.${MINOR}.$((PATCH+1))"
          echo "next=$NEXT" >> $GITHUB_OUTPUT
          echo "Next tag = $NEXT"

      - name: Dispatch build-windows.yml on v3.0.0 with the next release tag
        if: steps.decide.outputs.needs_build == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REF="${{ env.TARGET_BRANCH }}"
          VERSION="${{ steps.bump.outputs.next }}"
          echo "Dispatching ${{ env.BUILD_WORKFLOW_FILE }} (ref=$REF, version=$VERSION)"

          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/${{ env.BUILD_WORKFLOW_FILE }}/dispatches \
            -d @- <<EOF
          {
            "ref": "${REF}",
            "inputs": {
              "ref": "${REF}",
              "version": "${VERSION}"
            }
          }
          EOF

      - name: Note
        run: echo "Done (if Selenium changed, build & release were triggered)."
